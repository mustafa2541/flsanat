<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>flsanat - فلوسك</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a25;
            --accent: #d4a853;
            --accent-dark: #b87333;
            --text-main: #f5f5f5;
            --text-muted: #888899;
            --border: #2a2a35;
            --danger: #ef4444;
            --success: #22c55e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        .bg-decor {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 15% 15%, rgba(212, 168, 83, 0.08), transparent 40%), radial-gradient(circle at 85% 85%, rgba(184, 115, 51, 0.05), transparent 40%);
            pointer-events: none; z-index: 0;
        }

        /* --- Routing --- */
        .app-page {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-primary); z-index: 10;
            overflow-y: auto;
            opacity: 0; visibility: hidden; transform: translateX(20px);
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .app-page.active { opacity: 1; visibility: visible; transform: translateX(0); }

        /* --- Components --- */
        .card {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .header-bar {
            display: flex; align-items: center; justify-content: space-between; padding: 20px;
            position: sticky; top: 0; background: rgba(10, 10, 15, 0.9); backdrop-filter: blur(10px);
            z-index: 50; border-bottom: 1px solid var(--border);
        }
        .btn {
            padding: 14px 24px; border-radius: 12px; font-weight: 700; font-size: 16px;
            cursor: pointer; transition: all 0.2s; border: none; text-align: center;
        }
        .btn-gold { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: var(--bg-primary); box-shadow: 0 4px 15px rgba(212, 168, 83, 0.3); }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 168, 83, 0.4); }
        .btn-gold:disabled { background: #444; color: #888; box-shadow: none; transform: none; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 2px solid var(--accent); color: var(--accent); }
        .btn-outline:hover { background: rgba(212, 168, 83, 0.1); }

        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 14px; }
        .input-field {
            width: 100%; padding: 14px 16px; border-radius: 12px; border: 2px solid var(--border);
            background: var(--bg-primary); color: var(--text-main); font-family: inherit; font-size: 16px;
            outline: none; transition: border-color 0.3s;
        }
        .input-field:focus { border-color: var(--accent); }

        /* --- Specific --- */
        .points-box {
            text-align: center; padding: 30px; background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border: 2px solid var(--accent); border-radius: 24px; position: relative; overflow: hidden; margin-bottom: 24px;
        }
        .points-box::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 200%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shine 3s infinite;
        }
        @keyframes shine { to { transform: translateX(50%); } }
        .points-num { font-size: 3.5rem; font-weight: 900; background: linear-gradient(to bottom, #f0d078, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .main-counter-btn {
            width: 160px; height: 160px; border-radius: 50%; background: linear-gradient(145deg, var(--accent), var(--accent-dark));
            border: none; color: var(--bg-primary); font-weight: 900; font-size: 18px; cursor: pointer;
            box-shadow: 0 10px 30px rgba(212, 168, 83, 0.4); transition: all 0.3s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 20px auto;
            position: relative;
        }
        .main-counter-btn:active { transform: scale(0.95); }
        .main-counter-btn.disabled { background: #333; color: #666; box-shadow: none; cursor: not-allowed; }
        .pulse-ring { position: absolute; width: 100%; height: 100%; border: 2px solid var(--accent); border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary);
            padding: 10px 20px; border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 100;
        }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); background: none; border: none; cursor: pointer; transition: color 0.2s; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn svg { width: 24px; height: 24px; margin-bottom: 4px; }

        /* Toast & Loading */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); border: 1px solid var(--accent); padding: 12px 24px; border-radius: 50px; z-index: 999; opacity: 0; transition: all 0.3s; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .loading-screen { position: fixed; inset: 0; background: var(--bg-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Menu & Modals */
        .menu-side { position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background: var(--bg-secondary); z-index: 200; padding: 30px 20px; transition: right 0.3s; border-left: 1px solid var(--border); }
        .menu-side.open { right: 0; }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 199; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .menu-overlay.open { opacity: 1; visibility: visible; }

        .task-item { display: flex; align-items: center; padding: 12px; background: var(--bg-primary); border-radius: 12px; margin-bottom: 10px; }
        .auth-tab { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-muted); font-weight: 700; cursor: pointer; border-radius: 8px; transition: 0.2s; }
        .auth-tab.active { background: var(--accent); color: var(--bg-primary); }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading-screen">
        <h1 style="font-size: 2rem; color: var(--accent); margin-bottom: 20px;">flsanat</h1>
        <div class="spinner"></div>
    </div>

    <div id="toast" class="toast">Message</div>
    <div class="bg-decor"></div>

    <!-- Menu Overlay -->
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>
    <div id="sideMenu" class="menu-side">
        <h2 style="margin-bottom: 30px; font-size: 1.2rem;">القائمة</h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-outline" onclick="navigateTo('mainPage'); toggleMenu();">الرئيسية</button>
            <button class="btn btn-outline" onclick="navigateTo('rewardsPage'); toggleMenu();">المكافآت</button>
            <button class="btn btn-outline" onclick="navigateTo('settingsPage'); toggleMenu();">الإعدادات</button>
            <hr style="border-color: var(--border); margin: 10px 0;">
            <button class="btn" style="background: #333; color: #fff;" onclick="openAdminModal(); toggleMenu();">لوحة التحكم</button>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="adminModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:300; display:none; justify-content:center; align-items:center;">
        <div class="card" style="width: 90%; max-width: 400px;">
            <h3 style="margin-bottom: 15px; text-align:center;">دخول لوحة التحكم</h3>
            <input type="password" id="adminPassInput" class="input-field" placeholder="كلمة المرور">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" style="background:#333; flex:1;" onclick="document.getElementById('adminModal').style.display='none'">إلغاء</button>
                <button class="btn btn-gold" style="flex:1;" onclick="verifyAdmin()">دخول</button>
            </div>
        </div>
    </div>

    <!-- ================= PAGES ================= -->

    <!-- 1. Auth Page -->
    <div id="authPage" class="app-page active">
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 20px;">
            <div style="text-align: center; margin-bottom: 40px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; box-shadow: 0 10px 30px rgba(212, 168, 83, 0.3);">
                    <span style="font-size: 2rem; color: #000;">$</span>
                </div>
                <h1 style="font-size: 2.5rem; font-weight: 900; color: var(--accent);">flsanat</h1>
                <p style="color: var(--text-muted);">سجل الآن وابدأ الربح</p>
            </div>
            <div class="card" style="width: 100%; max-width: 400px;">
                <div style="display: flex; margin-bottom: 20px; background: var(--bg-primary); border-radius: 12px; padding: 4px;">
                    <button id="tabLogin" class="auth-tab active" onclick="switchAuthTab('login')">دخول</button>
                    <button id="tabReg" class="auth-tab" onclick="switchAuthTab('register')">جديد</button>
                </div>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="input-group"><label>البريد الإلكتروني</label><input type="email" id="logEmail" class="input-field" required></div>
                    <div class="input-group"><label>كلمة المرور</label><input type="password" id="logPass" class="input-field" required></div>
                    <button type="submit" class="btn btn-gold" style="width: 100%; margin-top: 10px;">تسجيل الدخول</button>
                </form>
                <form id="registerForm" style="display: none;" onsubmit="handleRegister(event)">
                    <div class="input-group"><label>الاسم الكامل</label><input type="text" id="regName" class="input-field" required></div>
                    <div class="input-group"><label>رقم الهاتف</label><input type="tel" id="regPhone" class="input-field" required placeholder="+964 ..."></div>
                    <div class="input-group"><label>البريد الإلكتروني</label><input type="email" id="regEmail" class="input-field" required></div>
                    <div class="input-group"><label>كلمة المرور</label><input type="password" id="regPass" class="input-field" required></div>
                    <button type="submit" class="btn btn-gold" style="width: 100%; margin-top: 10px;">إنشاء حساب</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 2. Main Page -->
    <div id="mainPage" class="app-page">
        <div class="header-bar">
            <button onclick="toggleMenu()" style="background: none; border: none; cursor: pointer;">
                <svg width="24" height="24" fill="none" stroke="var(--accent)" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <h1 style="font-size: 1.2rem; font-weight: 900; color: var(--accent);">flsanat</h1>
            <div style="width: 24px;"></div>
        </div>

        <!-- تم زيادة المساحة السفلية إلى 250px لضمان ظهور الزر بوضوح -->
        <div style="padding: 20px; padding-bottom: 250px;">
            <div class="points-box">
                <p style="color: var(--text-muted); margin-bottom: 5px;">رصيدك الحالي</p>
                <div class="points-num" id="mainPointsDisplay">0</div>
                <p style="color: var(--accent); font-weight: 700;" id="mainMoneyDisplay">0 دينار</p>
            </div>

            <div class="card" style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; color: var(--bg-primary);" id="userAvatarMain">U</div>
                <div>
                    <h3 style="font-size: 1.1rem;" id="userNameMain">اسم المستخدم</h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">ID: <span id="userIdMain">-</span></p>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: var(--text-muted);">الاشتراك</span>
                    <span style="color: var(--accent); font-weight: 700;" id="subNameMain">لا يوجد</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem;"><span>الإعلانات المتبقية</span><span id="adsRemMain">0/0</span></div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem;"><span>المهام المتبقية</span><span id="tasksRemMain">0/0</span></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <p style="color: var(--text-muted); margin-bottom: 10px;" id="timerText">اضغط لتفعيل العداد</p>
                <button id="mainActionBtn" class="main-counter-btn disabled" onclick="activateDaily()">
                    <div class="pulse-ring" style="display: none;" id="pulseRing"></div>
                    <svg width="40" height="40" fill="currentColor" viewBox="0 0 24 24" style="margin-bottom: 5px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/></svg>
                    <span id="btnMainText">تفعيل</span>
                </button>
                <p style="margin-top: 10px; font-size: 0.9rem;">النقاط التالية: <span id="nextPtsMain">0</span></p>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn active" onclick="navigateTo('mainPage')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
                <span>الرئيسية</span>
            </button>
            <button class="nav-btn" onclick="navigateTo('rewardsPage')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/></svg>
                <span>المكافآت</span>
            </button>
        </div>
    </div>

    <!-- 3. Rewards Page -->
    <div id="rewardsPage" class="app-page">
        <div class="header-bar">
            <button onclick="navigateTo('mainPage')" style="background: none; border: none; cursor: pointer;">
                <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
            </button>
            <h1 style="font-size: 1.1rem;">المكافآت والمهام</h1>
            <div style="width: 24px;"></div>
        </div>
        <div style="padding: 20px; padding-bottom: 100px;">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="tabAds" class="btn btn-gold" style="flex:1;" onclick="switchRewardTab('ads')">الإعلانات</button>
                <button id="tabTasks" class="btn btn-outline" style="flex:1;" onclick="switchRewardTab('tasks')">المهام</button>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span id="progressLabel">الإعلانات</span><span id="progressCount">0/0</span></div>
                <div style="height: 6px; background: var(--bg-primary); border-radius: 5px; overflow: hidden;"><div id="progressBar" style="height: 100%; background: var(--accent); width: 0%; transition: width 0.5s;"></div></div>
            </div>
            <div id="adsList"></div>
            <div id="tasksList" style="display: none;"></div>
        </div>
        <div class="bottom-nav">
            <button class="nav-btn" onclick="navigateTo('mainPage')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg><span>الرئيسية</span></button>
            <button class="nav-btn active" onclick="navigateTo('rewardsPage')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/></svg><span>المكافآت</span></button>
        </div>
    </div>

    <!-- 4. Settings Page -->
    <div id="settingsPage" class="app-page">
        <div class="header-bar">
            <button onclick="navigateTo('mainPage')" style="background: none; border: none; cursor: pointer;"><svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg></button>
            <h1 style="font-size: 1.1rem;">الإعدادات</h1>
            <div style="width: 24px;"></div>
        </div>
        <div style="padding: 20px;">
            <div class="card" style="text-align: center;">
                <div style="width: 80px; height: 80px; background: var(--accent); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 900; color: var(--bg-primary);" id="settingsAvatar">U</div>
                <h2 id="settingsName" style="margin-bottom: 5px;">اسم المستخدم</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">ID: <span id="settingsId">-</span></p>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);"><span style="color: var(--text-muted);">البريد الإلكتروني</span><span id="settingsEmail">-</span></div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);"><span style="color: var(--text-muted);">رقم الهاتف</span><span id="settingsPhone">-</span></div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0;"><span style="color: var(--text-muted);">تاريخ التسجيل</span><span id="settingsDate">-</span></div>
            </div>
            <button class="btn btn-outline" style="width: 100%; margin-bottom: 10px;" onclick="editProfile()">تعديل الملف الشخصي</button>
            <button class="btn" style="width: 100%; background: var(--danger); color: white;" onclick="logout()">تسجيل الخروج</button>
        </div>
    </div>

    <!-- 5. Admin Page -->
    <div id="adminPage" class="app-page">
        <div class="header-bar">
            <button onclick="navigateTo('mainPage')" style="background: none; border: none; cursor: pointer;"><svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg></button>
            <h1 style="font-size: 1.1rem;">لوحة التحكم</h1>
            <div style="width: 24px;"></div>
        </div>
        <div style="padding: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="card" style="text-align: center;"><h2 id="adminTotalUsers" style="font-size: 2rem; color: var(--accent);">0</h2><p style="font-size: 0.8rem; color: var(--text-muted);">المستخدمين</p></div>
                <div class="card" style="text-align: center;"><h2 id="adminActiveSubs" style="font-size: 2rem; color: var(--success);">0</h2><p style="font-size: 0.8rem; color: var(--text-muted);">اشتراكات نشطة</p></div>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 15px;">تفعيل اشتراك</h3>
                <div class="input-group"><label>ID المستخدم</label><input type="text" id="inputAdminId" class="input-field" placeholder="FLS..."></div>
                <div class="input-group"><label>نوع الاشتراك</label>
                    <select id="selectAdminPlan" class="input-field">
                        <option value="50000">50,000 (5 اعلانات)</option><option value="100000">100,000 (10 اعلانات)</option>
                        <option value="500000">500,000 (50 اعلان)</option><option value="1000000">1,000,000 (100 اعلان)</option>
                    </select>
                </div>
                <button class="btn btn-gold" style="width: 100%;" onclick="adminActivate()">تفعيل</button>
            </div>
            <div class="card"><h3 style="margin-bottom: 15px;">قائمة المستخدمين</h3><div id="adminUserList" style="max-height: 300px; overflow-y: auto;"></div></div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:300; display:none; justify-content:center; align-items:center;">
        <div class="card" style="width: 90%; max-width: 400px;">
            <h3 style="margin-bottom: 15px;">تعديل البيانات</h3>
            <div class="input-group"><label>الاسم</label><input type="text" id="editNameInp" class="input-field"></div>
            <div class="input-group"><label>الهاتف</label><input type="text" id="editPhoneInp" class="input-field"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:#333;" onclick="document.getElementById('editModal').style.display='none'">إلغاء</button>
                <button class="btn btn-gold" style="flex:1;" onclick="saveProfile()">حفظ</button>
            </div>
        </div>
    </div>

    <script>
        // ================= FIREBASE SETUP =================
        const firebaseConfig = {
            apiKey: "AIzaSyA5OkCjzM7JXWJM8bK9ogPfYn9PQvuwKEg",
            authDomain: "flsanat-7f1df.firebaseapp.com",
            projectId: "flsanat-7f1df",
            storageBucket: "flsanat-7f1df.firebasestorage.app",
            messagingSenderId: "202175832550",
            appId: "1:202175832550:web:62bdac9e619a26e25cb627",
            measurementId: "G-3NMHCWHPQ3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // ================= CONSTANTS =================
        const PLANS = {
            50000: { name: "50,000 دينار", ads: 5, tasks: 5, pts: 1500 },
            100000: { name: "100,000 دينار", ads: 10, tasks: 10, pts: 3000 },
            500000: { name: "500,000 دينار", ads: 50, tasks: 50, pts: 15000 },
            1000000: { name: "1,000,000 دينار", ads: 100, tasks: 100, pts: 30000 }
        };
        const PTS_VAL = 0.2;
        const AD_PT = 45;
        const TASK_PT = 45;
        const ADMIN_PASS = "2541";

        let currentUser = null;
        let userData = null;

        // ================= UI FUNCTIONS =================
        function $(id) { return document.getElementById(id); }
        
        function showToast(msg) {
            const t = $('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function navigateTo(pageId) {
            document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
            $(pageId).classList.add('active');
        }

        function toggleMenu() {
            $('sideMenu').classList.toggle('open');
            $('menuOverlay').classList.toggle('open');
        }

        function openAdminModal() { $('adminModal').style.display = 'flex'; }

        function switchAuthTab(tab) {
            if(tab === 'login') { $('loginForm').style.display = 'block'; $('registerForm').style.display = 'none'; $('tabLogin').classList.add('active'); $('tabReg').classList.remove('active'); }
            else { $('loginForm').style.display = 'none'; $('registerForm').style.display = 'block'; $('tabLogin').classList.remove('active'); $('tabReg').classList.add('active'); }
        }

        function switchRewardTab(tab) {
            if(tab === 'ads') { $('adsList').style.display = 'block'; $('tasksList').style.display = 'none'; $('tabAds').className = 'btn btn-gold'; $('tabTasks').className = 'btn btn-outline'; updateRewardUI('ads'); }
            else { $('adsList').style.display = 'none'; $('tasksList').style.display = 'block'; $('tabAds').className = 'btn btn-outline'; $('tabTasks').className = 'btn btn-gold'; updateRewardUI('tasks'); }
        }

        // ================= CORE LOGIC =================
        function formatNum(n) { return n.toLocaleString('ar-IQ'); }
        function genId() { return 'FLS' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 4).toUpperCase(); }

        function updateUI() {
            if(!userData) return;
            $('mainPointsDisplay').textContent = formatNum(userData.points || 0);
            $('mainMoneyDisplay').textContent = formatNum((userData.points || 0) * PTS_VAL) + ' دينار';
            $('userNameMain').textContent = userData.name || 'مستخدم';
            $('userIdMain').textContent = userData.id || '-';
            $('userAvatarMain').textContent = (userData.name || 'U').charAt(0);

            if(userData.subscription) {
                const p = PLANS[userData.subscription.price];
                $('subNameMain').textContent = p.name;
                $('adsRemMain').textContent = `${userData.adsWatched || 0}/${p.ads}`;
                $('tasksRemMain').textContent = `${userData.tasksCompleted || 0}/${p.tasks}`;
                $('nextPtsMain').textContent = formatNum(p.pts);
            } else {
                $('subNameMain').textContent = 'لا يوجد اشتراك'; $('adsRemMain').textContent = '0/0'; $('tasksRemMain').textContent = '0/0'; $('nextPtsMain').textContent = '0';
            }
            updateButtonState();

            $('settingsName').textContent = userData.name || '-'; $('settingsId').textContent = userData.id || '-'; $('settingsEmail').textContent = userData.email || '-';
            $('settingsPhone').textContent = userData.phone || '-'; $('settingsDate').textContent = userData.createdAt ? new Date(userData.createdAt).toLocaleDateString('ar-IQ') : '-';
            $('settingsAvatar').textContent = (userData.name || 'U').charAt(0);

            updateRewardUI('ads'); updateRewardUI('tasks');
        }

        function updateButtonState() {
            const now = Date.now(); const last = userData.lastCounterPress || 0; const diff = now - last; const wait = 86400000;
            const btn = $('mainActionBtn'); const txt = $('btnMainText'); const ring = $('pulseRing'); const timerTxt = $('timerText');
            if(!userData.subscription) { btn.classList.add('disabled'); txt.textContent = 'لا يوجد اشتراك'; timerTxt.textContent = 'يجب تفعيل اشتراك من الإعدادات'; ring.style.display = 'none'; return; }
            if(diff >= wait) { btn.classList.remove('disabled'); txt.textContent = 'تفعيل'; timerTxt.textContent = 'العداد جاهز للتفعيل'; ring.style.display = 'block'; }
            else { const rem = wait - diff; const h = Math.floor(rem / 3600000); const m = Math.floor((rem % 3600000) / 60000); btn.classList.add('disabled'); txt.textContent = `${h}:${m.toString().padStart(2, '0')}`; timerTxt.textContent = `الوقت المتبقي: ${h} ساعة و ${m} دقيقة`; ring.style.display = 'none'; }
        }

        function updateRewardUI(type) {
            if(!userData || !userData.subscription) { $(type === 'ads' ? 'adsList' : 'tasksList').innerHTML = '<div class="card" style="text-align:center; color:var(--text-muted)">لا يوجد اشتراك</div>'; return; }
            const p = PLANS[userData.subscription.price]; const done = type === 'ads' ? (userData.adsWatched || 0) : (userData.tasksCompleted || 0); const total = type === 'ads' ? p.ads : p.tasks; const pts = type === 'ads' ? AD_PT : TASK_PT;
            if(type === 'ads') { $('progressLabel').textContent = 'الإعلانات'; $('progressCount').textContent = `${done}/${total}`; $('progressBar').style.width = `${(done/total)*100}%`; }
            else { $('progressLabel').textContent = 'المهام'; $('progressCount').textContent = `${done}/${total}`; $('progressBar').style.width = `${(done/total)*100}%`; }
            let html = '';
            for(let i=0; i<total; i++) {
                const completed = i < done;
                html += `<div class="task-item"><div style="width:40px; height:40px; border-radius:10px; background:${completed ? 'var(--success)' : 'var(--accent)'}; display:flex; align-items:center; justify-content:center; margin-left:10px;"><svg width="20" height="20" fill="white" viewBox="0 0 24 24">${completed ? '<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>' : '<path d="M8 5v14l11-7z"/>'}</svg></div><div style="flex:1;"><h4 style="font-size:1rem;">${type === 'ads' ? 'إعلان' : 'مهمة'} ${i+1}</h4><p style="font-size:0.8rem; color:var(--text-muted);">${completed ? 'تم' : pts + ' نقطة'}</p></div>${!completed ? `<button class="btn btn-outline" style="padding:8px 16px; font-size:0.8rem;" onclick="${type === 'ads' ? 'watchAd()' : 'doTask()'}">${type === 'ads' ? 'مشاهدة' : 'إكمال'}</button>` : ''}</div>`;
            }
            $(type === 'ads' ? 'adsList' : 'tasksList').innerHTML = html;
        }

        // ================= ACTIONS =================
        async function handleLogin(e) { e.preventDefault(); try { await auth.signInWithEmailAndPassword($('logEmail').value, $('logPass').value); showToast('مرحباً بعودتك'); } catch(err) { showToast('خطأ: ' + err.message); } }
        async function handleRegister(e) { e.preventDefault(); try { const cred = await auth.createUserWithEmailAndPassword($('regEmail').value, $('regPass').value); const uid = genId(); await db.ref('users/' + cred.user.uid).set({ id: uid, name: $('regName').value, email: $('regEmail').value, phone: $('regPhone').value, points: 0, createdAt: Date.now(), subscription: null, adsWatched: 0, tasksCompleted: 0, lastCounterPress: 0 }); showToast('تم إنشاء الحساب'); } catch(err) { showToast('خطأ: ' + err.message); } }
        function logout() { auth.signOut(); }
        function listenData(uid) { db.ref('users/' + uid).on('value', snap => { userData = snap.val(); updateUI(); }); }
        
        async function activateDaily() {
            if(!userData.subscription) return showToast('لا يوجد اشتراك');
            if(document.querySelector('#mainActionBtn').classList.contains('disabled')) return;
            const p = PLANS[userData.subscription.price];
            const newPts = (userData.points || 0) + p.pts;
            await db.ref('users/' + currentUser.uid).update({ points: newPts, lastCounterPress: Date.now() });
            showToast(`+${formatNum(p.pts)} نقطة!`);
        }

        async function watchAd() {
            const p = PLANS[userData.subscription.price];
            if((userData.adsWatched || 0) >= p.ads) return showToast('اكتملت الإعلانات');
            showToast('جاري تحميل الإعلان...');
            await new Promise(r => setTimeout(r, 1000)); 
            await db.ref('users/' + currentUser.uid).update({ points: (userData.points || 0) + AD_PT, adsWatched: (userData.adsWatched || 0) + 1 });
            showToast(`+${AD_PT} نقطة`);
        }

        async function doTask() {
            const p = PLANS[userData.subscription.price];
            if((userData.tasksCompleted || 0) >= p.tasks) return showToast('اكتملت المهام');
            await db.ref('users/' + currentUser.uid).update({ points: (userData.points || 0) + TASK_PT, tasksCompleted: (userData.tasksCompleted || 0) + 1 });
            showToast(`+${TASK_PT} نقطة`);
        }

        function editProfile() { $('editNameInp').value = userData.name || ''; $('editPhoneInp').value = userData.phone || ''; $('editModal').style.display = 'flex'; }
        async function saveProfile() { await db.ref('users/' + currentUser.uid).update({ name: $('editNameInp').value, phone: $('editPhoneInp').value }); $('editModal').style.display = 'none'; showToast('تم الحفظ'); }

        function verifyAdmin() { if($('adminPassInput').value === ADMIN_PASS) { $('adminModal').style.display = 'none'; loadAdminData(); navigateTo('adminPage'); } else showToast('كلمة المرور خاطئة'); }
        
        async function loadAdminData() {
            const snap = await db.ref('users').once('value'); const users = snap.val(); let cnt = 0, sub = 0; let html = '';
            if(users) { cnt = Object.keys(users).length; Object.values(users).forEach(u => { if(u.subscription) sub++; html += `<div style="background:var(--bg-primary); padding:10px; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div><p style="font-weight:700">${u.name}</p><p style="font-size:0.75rem; color:var(--text-muted)">${u.id}</p></div><span style="font-size:0.75rem; padding:4px 8px; border-radius:4px; background:${u.subscription ? 'var(--success)' : '#333'}">${u.subscription ? 'مشترك' : 'عادي'}</span></div>`; }); }
            $('adminTotalUsers').textContent = cnt; $('adminActiveSubs').textContent = sub; $('adminUserList').innerHTML = html || 'لا يوجد مستخدمين';
        }

        async function adminActivate() {
            const id = $('inputAdminId').value; const plan = $('selectAdminPlan').value; if(!id) return showToast('أدخل الـ ID');
            const snap = await db.ref('users').orderByChild('id').equalTo(id).once('value'); const data = snap.val(); if(!data) return showToast('المستخدم غير موجود');
            const uid = Object.keys(data)[0];
            await db.ref('users/' + uid).update({ subscription: { price: plan, at: Date.now() }, adsWatched: 0, tasksCompleted: 0, lastCounterPress: 0 });
            showToast('تم تفعيل الاشتراك'); loadAdminData();
        }

        // ================= AUTH STATE =================
        auth.onAuthStateChanged(user => {
            $('loadingScreen').style.opacity = '0'; setTimeout(() => $('loadingScreen').style.display = 'none', 500);
            if(user) { currentUser = user; listenData(user.uid); navigateTo('mainPage'); }
            else { currentUser = null; userData = null; navigateTo('authPage'); }
        });
        setInterval(() => { if(userData) updateButtonState(); }, 60000);
    </script>
</body>
</html>